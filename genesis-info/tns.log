8f7ffed16 scripts/generate/genesis.sh:  some more order in the business
diff --git a/scripts/generate/genesis.sh b/scripts/generate/genesis.sh
index 7d2d08846..ac55a5b09 100755
--- a/scripts/generate/genesis.sh
+++ b/scripts/generate/genesis.sh
@@ -2,10 +2,33 @@
 
 # This script generates genesis files.
 # Launch it from the project root directory.
-# It will create a directory with all needed data inside. It will not 
+# It will create a directory with all needed data inside. It will not
 # copy generated genesis files into the project, this is to be done
 # manually.
 
+set -e
+
+BUILD_MODE=stack
+IOHKOPS_DIR=..
+INSTALL_TOO=
+FAKE_AVVM_ENTRIES=100
+RICHMEN_SHARE=0.94
+TESTNET_STAKE=19072918462000000
+fail() { echo "ERROR: $*" >&2; exit 1;
+}
+while test $# -ge 1; do
+case "$1" in
+        --iohkops-dir )
+                IOHKOPS_DIR="$2"; shift;;
+        --build-mode )
+                case "$2" in 'nix' ) true;; 'stack' ) true;; * ) error "--build-mode should be either 'nix' or 'stack'";; esac;
+                BUILD_MODE="$2"; shift;;
+        --install-as-suffix )
+                case "$2" in 'tns' ) true;; 'tn' ) true;; 'qanet' ) true;; * ) error "--install-as-suffix should be either 'tn', 'tns' or 'qanet'";; esac;
+                INSTALL_AS_SUFFIX="$2"; shift;;
+        "--"* ) error "unknown option: $1";;
+        * ) break;; esac; shift; done
+
 scriptsDir="$( cd "$( dirname "${BASH_SOURCE[0]}" )" && pwd )"/..
 echo $scriptsDir
 outputDir="genesis-qanet-$(date +%F_%H-%M)"
@@ -20,26 +43,54 @@ mkdir $outputDir
 utxo_file=$scriptsDir/avvm-files/utxo-dump-last-new.json
 blacklisted=$scriptsDir/avvm-files/full_blacklist.js
 
-if [[ "$M" == "" ]]; then 
+if [[ "$M" == "" ]]; then
     echo "You didn't set M (rich keys amount)";
     exit 1
 fi
-if [[ "$N" == "" ]]; then 
+if [[ "$N" == "" ]]; then
     echo "You didn't set N (poor keys amount)";
     exit 1
 fi
 
-F=100 # fake avvm keys
+case "${BUILD_MODE}" in
+nix )
+        IOHKOPS_NIX=${IOHKOPS_DIR}/default.nix
+        test -f "${IOHKOPS_NIX}" ||
+                { echo "'${IOHKOPS_NIX}' doesn't exist, please supply a fitting --iohkops-dir" >&2; exit 1; }
+        KEYGEN_STOREPATH="$(nix-build --no-out-link --cores 0 --max-jobs 4 -A cardano-sl-tools-static ${IOHKOPS_NIX})"
+        test -d "${KEYGEN_STOREPATH}" ||
+                { echo "$KEYGEN_STOREPATH doesn't exist" >&2; exit 1; }
+        KEYGEN="${KEYGEN_STOREPATH}"/bin/cardano-keygen
+        test -x ${KEYGEN} ||
+                { echo "$KEYGEN doesn't exist" >&2; exit 1; }
+        keygen=${KEYGEN};;
+stack ) keygen="stack exec cardano-keygen --";;
+esac
 
 # print commit
 git show HEAD --oneline | tee $outputDir/genesisCreation.log
 
-keygenCmd="stack exec cardano-keygen -- generate-genesis --genesis-dir $outputDir -m $M -n $N --richmen-share 0.94 --testnet-stake 19072918462000000 --utxo-file $utxo_file --blacklisted $blacklisted --fake-avvm-entries $F"
+keygenCmd="${keygen} generate-genesis --genesis-dir $outputDir -m $M -n $N --richmen-share ${RICHMEN_SHARE} --testnet-stake ${TESTNET_STAKE} --utxo-file $utxo_file --blacklisted $blacklisted --fake-avvm-entries ${FAKE_AVVM_ENTRIES}"
 echo "Running command: $keygenCmd"
 $keygenCmd |& tee -a $outputDir/genesisCreation.log
 
 echo "Cleaning up"
-find $outputDir -name "*.lock" | xargs rm 
+find $outputDir -name "*.lock" | xargs rm
 
 echo "Creating archive"
 tar -czf "$outputDir.tgz" $outputDir
+
+if test -z "${INSTALL_AS_SUFFIX}"; then exit 0; fi
+echo "Installing genesis with suffix '${INSTALL_AS_SUFFIX}'"
+
+gencore="core/genesis-core-${INSTALL_AS_SUFFIX}.bin"
+gentoss="godtossing/genesis-godtossing-${INSTALL_AS_SUFFIX}.bin"
+geninfo="genesis-info/${INSTALL_AS_SUFFIX}.log"
+cp "${outputDir}"/genesis-core.bin       "${gencore}"
+cp "${outputDir}"/genesis-godtossing.bin "${gentoss}"
+cp "${outputDir}"/genesisCreation.log    "${geninfo}"
+
+echo "Genesis installed:"
+ls -l "${gencore}"
+ls -l "${gentoss}"
+ls -l "${geninfo}"
[94m[keygen:INFO:ThreadId 4] [0mProcessing command
[94m[keygen:INFO:ThreadId 4] [0mGenerating requested raw data
[94m[keygen:INFO:ThreadId 4] [0mGenerating avvm data
[94m[keygen:INFO:ThreadId 4] [0mRemoving 101 entries from utxo (out of 188 total entries in the blacklist)
[94m[keygen:INFO:ThreadId 4] [0mTotal avvm stake after applying blacklist: 25927070538000000
[94m[keygen:INFO:ThreadId 4] [0mGenerating fake avvm data into genesis-qanet-2017-08-09_13-22/keys-fakeavvm
[94m[keygen:INFO:ThreadId 4] [0m100 fake avvm seeds are generated
[94m[keygen:INFO:ThreadId 4] [0mGenerating testnet data into genesis-qanet-2017-08-09_13-22/keys-testnet
[94m[keygen:INFO:ThreadId 4] [0m1214 keyfiles are generated
[94m[keygen:INFO:ThreadId 4] [0mtestnet genesis created successfully. First 10 addresses: [PubKeyAddress c0ac2299a036aaf3184067b9497a1bb42395b3b3b38d5f6a14591122 (attrs: {}), PubKeyAddress 6b6b579c3f82c47eb53c54a9d8ca09d2ab5603efd0688a4d74855b34 (attrs: {}), PubKeyAddress dc723dcb425b39780f18c9a458ed89483daa2c00c3be1e0e76087a75 (attrs: {}), PubKeyAddress 5d4bef578bfd8893efd6b1ed89cce11c6340c12d067845c2fbaad175 (attrs: {}), PubKeyAddress b11907d963215ed765b6bbbae9aa19b2b15dd7d888b5f9d66b7a0016 (attrs: {}), PubKeyAddress de2814d6eaa2e4bf380dfbec4bdeee3f6bede76a2200d6882556ec21 (attrs: {}), PubKeyAddress 8bc35b1330cbd7412cff7f40f0e56651ce12f510334f491a3e77c668 (attrs: {}), PubKeyAddress 8be192263fde9a934f3f615d7e92cdfaeea77b8a6dc0320720a4be5e (attrs: {}), PubKeyAddress 3f01af3cbf3c21a7779cf22de2ef62e0c2a016348f1acc1206412c41 (attrs: {}), PubKeyAddress 5c1418f6c6fdb3bd09cd25ebe3aeedb9aa965474c614fec8bcf8558f (attrs: {})] distr: RichPoorStakes {sdRichmen = 14, sdRichStake = Coin {getCoin = 1280610239591429}, sdPoor = 2400, sdPoorStake = Coin {getCoin = 476822961549}}
[94m[keygen:INFO:ThreadId 4] [0mgenesis-core.bin generated successfully
[94m[keygen:INFO:ThreadId 4] [0mgenesis-godtossing.bin generated successfully
